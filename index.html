<!-- ... (Keep Head and Styles same as before) ... -->
<!-- Just showing the Script part that changed -->

<script>
    // ... UserAgent check ...

    // HARDCODED FALLBACK 
    const FALLBACK_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzukFBsABkTd-N84j_YnFfL-cfUHEXkuUC9ez904sROC9EJWlNF_2ztyy7D0rM2uH6F/exec"; 

    window.onload = function() {
        const savedPasskey = localStorage.getItem('userPasskey');
        if (savedPasskey) {
            document.getElementById('login-card').style.display = 'none';
            document.getElementById('session-overlay').style.display = 'flex';
            checkSession(savedPasskey);
        }
    };

    function checkSession(passkey) {
        // ... (Same device ID logic) ...
        let deviceId = "browser_user";
        let scriptUrl = FALLBACK_SCRIPT_URL;
        if (typeof Android !== 'undefined') {
             try { deviceId = Android.getDeviceId(); scriptUrl = Android.getScriptUrl(); } catch(e){}
        }

        fetch(scriptUrl + "?passkey=" + passkey + "&deviceId=" + deviceId)
        .then(res => res.json())
        .then(data => {
            if(data.result === 'success') {
                localStorage.setItem('userBatch', data.batch);
                // NEW: SAVE REFERRAL CODE
                localStorage.setItem('referralCode', data.referralCode);
                
                window.location.href = 'app.html';
            } else {
                forceLogout(data.message);
            }
        })
        .catch(err => forceLogout("Connection Failed"));
    }

    function verify() {
        // ... (Same input logic) ...
        const key = document.getElementById('passkey').value.trim();
        // ...
        
        let deviceId = "browser_user";
        let scriptUrl = FALLBACK_SCRIPT_URL;
        if (typeof Android !== 'undefined') {
             try { deviceId = Android.getDeviceId(); scriptUrl = Android.getScriptUrl(); } catch(e){}
        }

        fetch(scriptUrl + "?passkey=" + key + "&deviceId=" + deviceId)
        .then(res => res.json())
        .then(data => {
            if(data.result === 'success') {
                localStorage.setItem('isVerified', 'true');
                localStorage.setItem('userBatch', data.batch);
                localStorage.setItem('userPasskey', key);
                
                // NEW: SAVE REFERRAL CODE
                localStorage.setItem('referralCode', data.referralCode);

                if(typeof Android !== 'undefined') Android.onLoginSuccess();
                window.location.href = 'app.html';
            } else {
                showError(data.message || "Invalid Key");
                // ... reset buttons ...
            }
        })
        // ... catch errors ...
    }
    
    // ... forceLogout and showError functions ...
</script>
